<?php

/**
 * @file
 * Module file of the translation management test module.
 */

/**
 * Implements hook_tmgmt_translator_plugin_info().
 */
function tmgmt_transifex_tmgmt_translator_plugin_info() {
  return array(
    'transifex' => array(
      'label' => t('Transifex translator'),
      'description' => t('Transifex Translator service.'),
      'plugin controller class' => 'TMGMTTransifexTranslatorPluginController',
      'ui controller class' => 'TMGMTTransifexTranslatorUIController',
      'default settings' => array(
        'api' => '',
        'tx' => '',
        'project' => '',
      ),
    ),
  );
}

/**
 * Validation callback for the plugin settings form.
 */
function tmgmt_transifex_plugin_settings_form_validate($element, &$form_state, $form) {
  $settings = $form_state['values']['settings'];
  // Only validate the API key if one was provided.
  if (empty($settings['api'])) {
    return;
  }

  /** @var TMGMTTranslator $translator */
  $translator = $form_state['tmgmt_translator'];
  // Update translator settings with form data.
  $translator->settings = $settings;
  /** @var TMGMTTransifexTranslatorPluginController $controller */
  $controller = $translator->getController();
  if (!$controller->getTransifexProject($translator)) {
    form_error($element, t('The "Transifex API Key" is not valid or the target transifex project does not exist.'));
  }
}

/**
 * Implements hook_menu().
 */
function tmgmt_transifex_menu() {
  $items['tmgmt_transifex/webhook'] = array(
    'title' => 'Transifex webhook',
    'page callback' => 'tmgmt_transifex_validate_webhook',
    'access callback' => TRUE,
  );
  return $items;
}

/**
 * Page callback; GutHub WebHook endpoint.
 */
function tmgmt_transifex_validate_webhook() {
  $received_json = file_get_contents("php://input",  TRUE);
  $json = drupal_json_decode($received_json, TRUE);

  $translator = tmgmt_translator_load('transifex');
  $tx = new TransifexApi($translator);
  $http_verb = 'POST';
  $webhook_sig = $_SERVER['HTTP_X_TX_SIGNATURE_V2'];
  $http_url_path = $_SERVER['HTTP_X_TX_URL'];
  $http_gmt_date = $_SERVER['HTTP_HTTP_DATE'];
  $content_md5 = md5($received_json);
  $msg = join(PHP_EOL, array('POST', $http_url_path, $http_gmt_date, $content_md5));
  $sig = base64_encode(hash_hmac('sha256', $msg, '12345', true));

  $translations = array_reduce($tx->getTranslations('drupal-2_52', 'af'), function ($result, $item) {
    $result[$item->key] = $item->translation;
    return $result;
  }, array());
  $job = tmgmt_job_load(47);
  // echo json_encode($job->getItems());



  return;

  $translation['body'][0]['#text'] = 'Translation af body';
  $translation['node_title']['#text'] = 'Translation af node_title';
  $job->addTranslatedData(tmgmt_unflatten_data(array("838" => $translation)));

  echo json_encode($job->getItems());


  return;
  if ($sig == $webhook_sig) {
    // Change array of objects to hashmap
    $translations = array_reduce($tx->getTranslations('drupal-2_52', 'af'), function ($result, $item) {
      $result[$item->key] = $item->translation;
      return $result;
    }, array());
    // Prepare translation payload for body
    $body = '';
    $bodyCount = 0;

    while (isset($translations['Body' . $bodyCount])) {
      $body .= $translations['Body' . $bodyCount];
      $bodyCount += 1;
    }

    $translated = array();
    $translated['body'][0]['#text'] = $body;


    foreach ($translations as $key => $value) {
      if (strpos($key, 'Body') !== 0) $translated[$key]['#text'] = $value;
    }

    foreach ($tx->getResource('drupal-2_52/')->categories as $category) {
      preg_match('/tjid:(.*)/', $category, $tjid);
      if ($tjid[1]) {
        $tjid = $tjid[1];
        $job = tmgmt_job_load(intval($tjid));
        echo   json_encode($job->getData());
        foreach ($job->getItems() as $job_item) {
          if ($job_item->item_id == 52) {
            // echo json_encode($translated);
            echo $job_item->addTranslatedData(tmgmt_unflatten_data($translated));
          }
        }
      }
    }

  } else {
    echo 'Invalid webhook';
  }
}

function github_webhook_payload() {
  $payload = &drupal_static(__FUNCTION__);
  if (NULL === $payload) {
    $payload = (isset($_POST['payload'])) ? drupal_json_decode($_POST['payload']) : array();
  }
  return $payload;
}

/**
 * Delivery callback; Convets the array to JSON and returns.
 *
 * @param array $page_callback_result
 *   The result of a page callback. The array is simply converted to JSON, which
 *   is the rendered output of the page request.
 */
function tmgmt_webhook_json_deliver(array $page_callback_result) {
  drupal_add_http_header('Content-Type', 'application/json; charset=utf-8');
  print drupal_json_encode($page_callback_result);
  module_invoke_all('exit');
  drupal_session_commit();
}
